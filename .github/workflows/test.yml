name: Test Buddy Login Action

on: [push, workflow_dispatch]

env:
  TEST_API_URL: 'https://api.awsstage.net'

jobs:
  test-oidc:
    name: Test OIDC Authentication
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Buddy (OIDC)
        id: buddy_login
        uses: ./
        with:
          debug: true
          api_url: ${{ env.TEST_API_URL }}
          provider_id: ${{ secrets.BUDDY_PROVIDER_ID }}
          audience: 'buddy'

      - name: Verify BUDDY_TOKEN is set
        run: |
          if [ -z "$BUDDY_TOKEN" ]; then
            echo "Error: BUDDY_TOKEN is not set"
            exit 1
          fi
          echo "Success: BUDDY_TOKEN is set"

      - name: Verify BUDDY_API_ENDPOINT is set
        run: |
          if [ -z "$BUDDY_API_ENDPOINT" ]; then
            echo "Error: BUDDY_API_ENDPOINT is not set"
            exit 1
          fi
          echo "Success: BUDDY_API_ENDPOINT is set to $BUDDY_API_ENDPOINT"

      - name: Verify step outputs
        run: |
          if [ -z "${{ steps.buddy_login.outputs.token }}" ]; then
            echo "Error: Step output token is not set"
            exit 1
          fi
          echo "Success: Step output token is set"

          if [ -z "${{ steps.buddy_login.outputs.api_endpoint }}" ]; then
            echo "Error: Step output api_endpoint is not set"
            exit 1
          fi
          echo "Success: Step output api_endpoint is set"

      - name: Test API with token
        run: |
          echo "Testing OIDC token with Buddy API..."
          curl -X GET "$BUDDY_API_ENDPOINT/user" \
            -H "Authorization: Bearer $BUDDY_TOKEN" \
            -H "Content-Type: application/json"

  test-pat:
    name: Test PAT Authentication
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Buddy (PAT)
        id: buddy_login
        uses: ./
        with:
          debug: true
          token: ${{ secrets.BUDDY_PAT }}
          api_url: ${{ env.TEST_API_URL }}

      - name: Verify BUDDY_TOKEN is set
        run: |
          if [ -z "$BUDDY_TOKEN" ]; then
            echo "Error: BUDDY_TOKEN is not set"
            exit 1
          fi
          echo "Success: BUDDY_TOKEN is set"

      - name: Verify BUDDY_API_ENDPOINT is set
        run: |
          if [ -z "$BUDDY_API_ENDPOINT" ]; then
            echo "Error: BUDDY_API_ENDPOINT is not set"
            exit 1
          fi
          echo "Success: BUDDY_API_ENDPOINT is set to $BUDDY_API_ENDPOINT"

      - name: Verify step outputs
        run: |
          if [ -z "${{ steps.buddy_login.outputs.token }}" ]; then
            echo "Error: Step output token is not set"
            exit 1
          fi
          echo "Success: Step output token is set"

          if [ -z "${{ steps.buddy_login.outputs.api_endpoint }}" ]; then
            echo "Error: Step output api_endpoint is not set"
            exit 1
          fi
          echo "Success: Step output api_endpoint is set"

      - name: Test API with token
        run: |
          echo "Testing PAT with Buddy API..."
          curl -X GET "$BUDDY_API_ENDPOINT/user" \
            -H "Authorization: Bearer $BUDDY_TOKEN" \
            -H "Content-Type: application/json"

  test-error-scenarios-comprehensive:
    name: Test Error Scenarios (Comprehensive)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Test: No authentication provided - should fail
      - name: Test - No authentication params
        id: test_no_auth
        continue-on-error: true
        uses: ./
        with:
          debug: true
          api_url: ${{ env.TEST_API_URL }}

      - name: Verify - No authentication should fail
        run: |
          if [ "${{ steps.test_no_auth.outcome }}" == "success" ]; then
            echo "ERROR: Action should have failed but succeeded"
            exit 1
          fi
          echo "✓ Action correctly failed when no authentication provided"

      # Test: Invalid provider_id - should fail
      - name: Test - Invalid provider_id (not UUID)
        id: test_invalid_provider
        continue-on-error: true
        uses: ./
        with:
          debug: true
          api_url: ${{ env.TEST_API_URL }}
          provider_id: 'not-a-uuid-just-random-text'
          audience: 'buddy'

      - name: Verify - Invalid provider_id should fail
        run: |
          if [ "${{ steps.test_invalid_provider.outcome }}" == "success" ]; then
            echo "ERROR: Action should have failed with invalid provider_id"
            exit 1
          fi
          echo "✓ Action correctly failed with invalid provider_id"

      # Test: Empty provider_id - should fail
      - name: Test - Empty provider_id
        id: test_empty_provider
        continue-on-error: true
        uses: ./
        with:
          debug: true
          api_url: ${{ env.TEST_API_URL }}
          provider_id: ''
          audience: 'buddy'

      - name: Verify - Empty provider_id should fail
        run: |
          if [ "${{ steps.test_empty_provider.outcome }}" == "success" ]; then
            echo "ERROR: Action should have failed with empty provider_id"
            exit 1
          fi
          echo "✓ Action correctly failed with empty provider_id"

      # Test: Non-existent provider_id - should fail
      - name: Test - Non-existent provider_id
        id: test_nonexistent_provider
        continue-on-error: true
        uses: ./
        with:
          debug: true
          api_url: ${{ env.TEST_API_URL }}
          provider_id: '00000000-0000-0000-0000-000000000000'
          audience: 'buddy'

      - name: Verify - Non-existent provider_id should fail
        run: |
          if [ "${{ steps.test_nonexistent_provider.outcome }}" == "success" ]; then
            echo "ERROR: Action should have failed with non-existent provider_id"
            exit 1
          fi
          echo "✓ Action correctly failed with non-existent provider_id"

      # Test: Empty token - should fail
      - name: Test - Empty token
        id: test_empty_token
        continue-on-error: true
        uses: ./
        with:
          debug: true
          api_url: ${{ env.TEST_API_URL }}
          token: ''

      - name: Verify - Empty token should fail
        run: |
          if [ "${{ steps.test_empty_token.outcome }}" == "success" ]; then
            echo "ERROR: Action should have failed with empty token"
            exit 1
          fi
          echo "✓ Action correctly failed with empty token"

      # Test: Invalid API URL format - should fail
      - name: Test - Invalid API URL format
        id: test_invalid_url
        continue-on-error: true
        uses: ./
        with:
          debug: true
          api_url: 'not-a-valid-url'
          provider_id: ${{ secrets.BUDDY_PROVIDER_ID }}
          audience: 'buddy'

      - name: Verify - Invalid API URL should fail
        run: |
          if [ "${{ steps.test_invalid_url.outcome }}" == "success" ]; then
            echo "ERROR: Action should have failed with invalid API URL"
            exit 1
          fi
          echo "✓ Action correctly failed with invalid API URL"

      # Test: HTTP instead of HTTPS - should fail
      - name: Test - HTTP instead of HTTPS
        id: test_http_url
        continue-on-error: true
        uses: ./
        with:
          debug: true
          api_url: 'http://api.awsstage.net'
          provider_id: ${{ secrets.BUDDY_PROVIDER_ID }}
          audience: 'buddy'

      - name: Verify - HTTP URL should fail
        run: |
          if [ "${{ steps.test_http_url.outcome }}" == "success" ]; then
            echo "ERROR: Action should have failed with HTTP URL (requires HTTPS)"
            exit 1
          fi
          echo "✓ Action correctly failed with HTTP URL"

      # Test: Invalid region - should fail
      - name: Test - Invalid region
        id: test_invalid_region
        continue-on-error: true
        uses: ./
        with:
          debug: true
          region: 'INVALID'
          token: ${{ secrets.BUDDY_PAT }}

      - name: Verify - Invalid region should fail
        run: |
          if [ "${{ steps.test_invalid_region.outcome }}" == "success" ]; then
            echo "ERROR: Action should have failed with invalid region"
            exit 1
          fi
          echo "✓ Action correctly failed with invalid region"

      # Test: Wrong API endpoint - should fail
      - name: Test - Wrong API endpoint (connection failure)
        id: test_wrong_endpoint
        continue-on-error: true
        uses: ./
        with:
          debug: true
          api_url: 'https://httpstat.us/500'
          provider_id: ${{ secrets.BUDDY_PROVIDER_ID }}
          audience: 'buddy'

      - name: Verify - Wrong endpoint should fail
        run: |
          if [ "${{ steps.test_wrong_endpoint.outcome }}" == "success" ]; then
            echo "ERROR: Action should have failed with wrong endpoint"
            exit 1
          fi
          echo "✓ Action correctly failed with wrong endpoint"

      # Test: Empty audience - should fail
      - name: Test - Empty audience
        id: test_empty_audience
        continue-on-error: true
        uses: ./
        with:
          debug: true
          api_url: ${{ env.TEST_API_URL }}
          provider_id: ${{ secrets.BUDDY_PROVIDER_ID }}
          audience: ''

      - name: Verify - Empty audience should fail
        run: |
          if [ "${{ steps.test_empty_audience.outcome }}" == "success" ]; then
            echo "ERROR: Action should have failed with empty audience"
            exit 1
          fi
          echo "✓ Action correctly failed with empty audience"

      # Summary
      - name: All error scenario tests passed
        run: |
          echo "================================================"
          echo "✓ All error scenarios correctly handled"
          echo "✓ Action properly fails with invalid inputs"
          echo "✓ Token validation working as expected"
          echo "================================================"
